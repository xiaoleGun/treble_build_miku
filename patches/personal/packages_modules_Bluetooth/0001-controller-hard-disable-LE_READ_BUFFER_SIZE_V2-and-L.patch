From 4a5995e3c332351d52e349c071780f32edbb96da Mon Sep 17 00:00:00 2001
From: SGCMarkus <markusornik@gmail.com>
Date: Sun, 2 Oct 2022 14:47:31 +0200
Subject: [PATCH] controller: hard disable LE_READ_BUFFER_SIZE_V2 and
 LE_SET_HOST_FEATURE

yupik/shimas bluetooth firmware seems to report these to be working (it
should work, as these chipsets support Bluetooth 5.2 according to Qcom),
but something about their implementation seems to be broken.

Disable it for now, till Android 13 firmware becomes available.

Change-Id: Ifa84349d5829995283e19806e1c664365323f9ba
---
 system/gd/hci/controller.cc | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/system/gd/hci/controller.cc b/system/gd/hci/controller.cc
index f02e887567..eb66b0cd76 100644
--- a/system/gd/hci/controller.cc
+++ b/system/gd/hci/controller.cc
@@ -807,7 +807,7 @@ struct Controller::impl {
       OP_CODE_MAPPING(LE_SET_DEFAULT_PERIODIC_ADVERTISING_SYNC_TRANSFER_PARAMETERS)
       OP_CODE_MAPPING(LE_GENERATE_DHKEY_COMMAND)
       OP_CODE_MAPPING(LE_MODIFY_SLEEP_CLOCK_ACCURACY)
-      OP_CODE_MAPPING(LE_READ_BUFFER_SIZE_V2)
+      //OP_CODE_MAPPING(LE_READ_BUFFER_SIZE_V2)
       OP_CODE_MAPPING(LE_READ_ISO_TX_SYNC)
       OP_CODE_MAPPING(LE_SET_CIG_PARAMETERS)
       OP_CODE_MAPPING(LE_SET_CIG_PARAMETERS_TEST)
@@ -822,7 +822,7 @@ struct Controller::impl {
       OP_CODE_MAPPING(LE_REQUEST_PEER_SCA)
       OP_CODE_MAPPING(LE_SETUP_ISO_DATA_PATH)
       OP_CODE_MAPPING(LE_REMOVE_ISO_DATA_PATH)
-      OP_CODE_MAPPING(LE_SET_HOST_FEATURE)
+      //OP_CODE_MAPPING(LE_SET_HOST_FEATURE)
       OP_CODE_MAPPING(LE_READ_ISO_LINK_QUALITY)
       OP_CODE_MAPPING(LE_ENHANCED_READ_TRANSMIT_POWER_LEVEL)
       OP_CODE_MAPPING(LE_READ_REMOTE_TRANSMIT_POWER_LEVEL)
@@ -840,6 +840,13 @@ struct Controller::impl {
       OP_CODE_MAPPING(LE_SUBRATE_REQUEST)
       OP_CODE_MAPPING(SET_MIN_ENCRYPTION_KEY_SIZE)
 
+      case OpCode::LE_READ_BUFFER_SIZE_V2:
+        LOG_DEBUG("unsupported command opcode: 0x%04x", (uint16_t)OpCode::LE_READ_BUFFER_SIZE_V2);
+        return false;
+      case OpCode::LE_SET_HOST_FEATURE:
+        LOG_DEBUG("unsupported command opcode: 0x%04x", (uint16_t)OpCode::LE_SET_HOST_FEATURE);
+        return false;
+
       // deprecated
       case OpCode::ADD_SCO_CONNECTION:
         return false;
-- 
2.32.1 (Apple Git-133)

